name: CLA Check

on:
  pull_request_target:
    types:
      - opened
      - edited
      - synchronize
      - reopened

permissions:
  pull-requests: write
  issues: write

jobs:
  cla-check:
    name: Contributor License Agreement
    runs-on: self-hosted

    steps:
      - name: Check CLA acceptance (PowerShell)
        shell: powershell
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          # =====================================
          # Configuration
          # =====================================
          $CLA_PHRASE = "I have read and agree to the CLA"
          $REPO       = "${{ github.repository }}"
          $PR_NUMBER  = "${{ github.event.pull_request.number }}"
          $AUTHOR     = "${{ github.event.pull_request.user.login }}"

          Write-Host "Repository: $REPO"
          Write-Host "PR Number : #$PR_NUMBER"
          Write-Host "Author    : $AUTHOR"

          # =====================================
          # GitHub API headers
          # =====================================
          $headers = @{
            Authorization = "Bearer $env:GITHUB_TOKEN"
            Accept        = "application/vnd.github+json"
            "User-Agent"  = "SNI-CLA-Check"
          }

          # =====================================
          # Fetch issue comments
          # =====================================
          Write-Host "Fetching issue comments..."
          $comments = Invoke-RestMethod `
            -Uri "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" `
            -Headers $headers `
            -Method Get

          $accepted = $false

          foreach ($comment in $comments) {
            if ($comment.body -match "(?i)$CLA_PHRASE") {
              $accepted = $true
              break
            }
          }

          # =====================================
          # Fetch PR reviews (fallback)
          # =====================================
          if (-not $accepted) {
            Write-Host "Checking PR reviews..."
            $reviews = Invoke-RestMethod `
              -Uri "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews" `
              -Headers $headers `
              -Method Get

            foreach ($review in $reviews) {
              if ($review.body -and $review.body -match "(?i)$CLA_PHRASE") {
                $accepted = $true
                break
              }
            }
          }

          # =====================================
          # If NOT accepted ‚Üí comment + fail
          # =====================================
          if (-not $accepted) {

            Write-Host "CLA not accepted, posting bot comment..."

            $commentBody = @"
          ‚ùå **Contributor License Agreement not accepted**

          To proceed, please comment **exactly** the following sentence
          on this Pull Request (comment or review):


          üìÑ **CLA document**
          https://github.com/$REPO/blob/main/CLA.md

          Once the comment is added, this check will pass automatically.
          "@

            $payload = @{ body = $commentBody } | ConvertTo-Json

            Invoke-RestMethod `
              -Uri "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" `
              -Headers $headers `
              -Method Post `
              -Body $payload

            Write-Error "CLA not accepted"
            exit 1
          }

          Write-Host "‚úÖ CLA accepted"
