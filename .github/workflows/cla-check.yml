name: CLA Check

on:
  pull_request_target:
    types:
      - opened
      - edited
      - synchronize
      - reopened
      - ready_for_review

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  cla-check:
    name: Contributor License Agreement
    runs-on: self-hosted

    steps:
      - name: Check CLA acceptance (Windows PowerShell)
        shell: powershell
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          # ================================
          # Configuration
          # ================================
          $CLA_PHRASE = "I have read and agree to the CLA"
          $REPO       = "${{ github.repository }}"
          $PR_NUMBER  = "${{ github.event.pull_request.number }}"
          $AUTHOR     = "${{ github.event.pull_request.user.login }}"

          Write-Host "Repository: $REPO"
          Write-Host "PR Number : #$PR_NUMBER"
          Write-Host "Author    : $AUTHOR"

          # ================================
          # GitHub API headers
          # ================================
          $headers = @{
            Authorization = "Bearer $env:GITHUB_TOKEN"
            Accept        = "application/vnd.github+json"
            "User-Agent"  = "CLA-Check-Bot"
          }

          # ================================
          # Fetch PR comments
          # ================================
          try {
            $comments = Invoke-RestMethod `
              -Uri "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" `
              -Headers $headers `
              -Method Get
          }
          catch {
            Write-Error "Failed to fetch PR comments."
            throw
          }

          # ================================
          # Check CLA acceptance
          # ================================
          $accepted = $false

          foreach ($comment in $comments) {
            if ($comment.user.login -eq $AUTHOR -and
                $comment.body -match [regex]::Escape($CLA_PHRASE)) {
              $accepted = $true
              break
            }
          }

          # ================================
          # If not accepted → comment + fail
          # ================================
          if (-not $accepted) {

            $botComment = @"
          **CLA not accepted**

          Per poter unire questa Pull Request devi commentare **esattamente** la seguente frase:
          To merge this Pull Request you must comment **exactly** the following sentence:
            
          CLA:
          https://github.com/$REPO/blob/main/CLA.md

          Once the comment is added, this check will automatically pass.
          "@

            Invoke-RestMethod `
              -Uri "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" `
              -Headers $headers `
              -Method Post `
              -Body (@{ body = $botComment } | ConvertTo-Json -Depth 5)

            Write-Error "CLA not accepted"
            exit 1
          }

          Write-Host "✅ CLA accepted"
