name: CLA Check

on:
  pull_request_target:
    types: [ opened, edited, synchronize, reopened ]

permissions:
  contents: read
  checks: write
  pull-requests: write
  issues: write

jobs:
  cla-check:
    name: Contributor License Agreement
    runs-on: self-hosted

    steps:
      - name: Run CLA Check (GitHub Check Run)
        shell: powershell
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          # =====================================
          # Configuration
          # =====================================
          $CHECK_NAME = "Contributor License Agreement"
          $CLA_PHRASE = "I have read and agree to the CLA"

          $REPO       = "${{ github.repository }}"
          $OWNER, $REPO_NAME = $REPO -split "/"
          $PR_NUMBER  = "${{ github.event.pull_request.number }}"
          $AUTHOR     = "${{ github.event.pull_request.user.login }}"
          $SHA        = "${{ github.event.pull_request.head.sha }}"

          # =====================================
          # Headers
          # =====================================
          $headers = @{
            Authorization = "Bearer $env:GITHUB_TOKEN"
            Accept        = "application/vnd.github+json"
            "User-Agent"  = "SNI-CLA-Check/1.0"
          }

          # =====================================
          # Create Check Run (in_progress)
          # =====================================
          $createPayload = @{
            name    = $CHECK_NAME
            head_sha = $SHA
            status  = "in_progress"
          } | ConvertTo-Json

          $check = Invoke-RestMethod `
            -Uri "https://api.github.com/repos/$OWNER/$REPO_NAME/check-runs" `
            -Headers $headers `
            -Method Post `
            -Body $createPayload

          $CHECK_ID = $check.id

          # =====================================
          # Fetch comments & reviews (paginated)
          # =====================================
          function Get-AllPages($url) {
            $results = @()
            $page = 1
            do {
              $resp = Invoke-RestMethod -Uri "$url?per_page=100&page=$page" -Headers $headers
              $results += $resp
              $page++
            } while ($resp.Count -eq 100)
            return $results
          }

          $comments = Get-AllPages "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments"
          $reviews  = Get-AllPages "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews"

          $accepted = $false

          foreach ($item in $comments + $reviews) {
            if ($item.body -and
                $item.user.login -eq $AUTHOR -and
                $item.body -match [regex]::Escape($CLA_PHRASE)) {
              $accepted = $true
              break
            }
          }

          # =====================================
          # Prepare Check Run result
          # =====================================
          if ($accepted) {
            $conclusion = "success"
            $title = "CLA accepted"
            $summary = @"
            The contributor **$AUTHOR** has accepted the Contributor License Agreement.

            No further action is required.
            "@
          } else {
            $conclusion = "failure"
            $title = "CLA not accepted"
            $summary = @"
            The contributor **$AUTHOR** has not yet accepted the Contributor License Agreement.

            Required action:
            Comment the following sentence on this Pull Request (comment or review):

            "$CLA_PHRASE"

            CLA document:
            https://github.com/$REPO/blob/main/CLA.md
            "@
          }

          # =====================================
          # Update Check Run (completed)
          # =====================================
          $updatePayload = @{
            status      = "completed"
            conclusion  = $conclusion
            output      = @{
              title   = $title
              summary = $summary
            }
          } | ConvertTo-Json -Depth 5

          Invoke-RestMethod `
            -Uri "https://api.github.com/repos/$OWNER/$REPO_NAME/check-runs/$CHECK_ID" `
            -Headers $headers `
            -Method Patch `
            -Body $updatePayload

          if (-not $accepted) {
            Write-Error "CLA not accepted"
          }
