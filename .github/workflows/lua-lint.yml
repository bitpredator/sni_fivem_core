name: Lua Quality

on:
  push:
    branches: [ "main", "dev" ]

  pull_request:
    branches: [ "*" ]
    types: [ opened, synchronize, reopened, labeled ]

permissions:
  contents: read
  checks: write

jobs:
  lua-quality:
    name: Lua Lint & Formatting
    runs-on: ubuntu-latest

    steps:
      # ------------------------
      # CHECKOUT
      # ------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      # ------------------------
      # LUA LINT (iLLeniumStudios)
      # ------------------------
      - name: Run Lua Linter
        uses: iLLeniumStudios/fivem-lua-lint-action@v2
        with:
          capture: "junit.xml"
          args: "-t --formatter JUnit"
          extra_libs: mysql

      # ------------------------
      # STYLUA CHECK (CONDITIONAL)
      # ------------------------
      - name: Run Stylua Check
        if: >
          github.event_name == 'push' ||
          (github.event_name == 'pull_request' &&
           github.event.action == 'labeled' &&
           github.event.label.name == 'format_all')
        uses: JohnnyMorganz/stylua-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: v0.18.0
          args: --check .

      # ------------------------
      # PUBLISH JUNIT REPORT
      # ------------------------
      - name: Publish Lua Lint Report
        if: always()
        uses: mikepenz/action-junit-report@v6
        with:
          report_paths: "**/junit.xml"
          check_name: Lua Lint Report
          fail_on_failure: false
          include_passed: true
          include_empty_in_summary: true
          job_summary: true
          verbose_summary: true
          check_annotations: true
