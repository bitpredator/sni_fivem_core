name: Lua Quality (FiveM / ESX)

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "*" ]

permissions:
  contents: read
  checks: write

jobs:
  lint:
    name: Lua Quality (Windows Self-Hosted)
    runs-on: self-hosted

    steps:
      # ------------------------
      # CHECKOUT
      # ------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------
      # VERIFY BINARIES
      # ------------------------
      - name: Verify tools
        shell: powershell
        run: |
          $luacheckPath = "C:\tools\luacheck.exe"
          if (-Not (Test-Path $luacheckPath)) {
              Write-Host "luacheck.exe not found! Please verify path."
              exit 1
          } else {
              Write-Host "Found luacheck.exe"
              & $luacheckPath --version
          }

          $styluaPath = "C:\tools\stylua.exe"
          if (-Not (Test-Path $styluaPath)) {
              Write-Host "stylua.exe not found! Please verify path."
              exit 1
          } else {
              Write-Host "Found stylua.exe"
              & $styluaPath --version
          }

      # ------------------------
      # STYLUA (CHECK ONLY â†’ DIFF INLINE)
      # ------------------------
      - name: Stylua format check
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host "Running Stylua check..."
          $styluaPath = "C:\tools\stylua.exe"
          $report = "stylua-report.diff"

          # Run Stylua check in diff mode
          & $styluaPath . --diff > $report 2> stylua.log
          $exitCode = $LASTEXITCODE

          Add-Content $env:GITHUB_STEP_SUMMARY "## Stylua Format Check"
          if ($exitCode -eq 0) {
              Add-Content $env:GITHUB_STEP_SUMMARY "- No formatting issues detected."
          } else {
              Add-Content $env:GITHUB_STEP_SUMMARY "- Formatting issues detected. See stylua.diff below."
              Add-Content $env:GITHUB_STEP_SUMMARY ""
              Get-Content $report | ForEach-Object { Add-Content $env:GITHUB_STEP_SUMMARY ("`" + $_ + "`") }
          }

      # ------------------------
      # LUACHECK (JUnit + ANNOTATIONS)
      # ------------------------
      - name: Run Luacheck
        shell: powershell
        run: |
          Write-Host "Running Luacheck..."
          $luacheckPath = "C:\tools\luacheck.exe"
          & $luacheckPath . --config .luacheckrc --formatter JUnit --codes --quiet --no-color 1> junit.xml 2> luacheck.log
          exit 0

      # ------------------------
      # PUBLISH LUACHECK REPORT + WARNINGS INLINE
      # ------------------------
      - name: Publish Luacheck Report
        if: always()
        uses: mikepenz/action-junit-report@v6
        with:
          report_paths: junit.xml
          check_name: Lua Lint Report
          fail_on_failure: false
          include_passed: true
          include_empty_in_summary: true
          job_summary: true
          verbose_summary: true
          check_annotations: true
